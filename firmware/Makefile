CC =  /opt/microchip/xc8/bin/xc8
MDB = /opt/microchip/mplabx/mplab_ide/bin/mdb.sh

PK2CMD = /usr/local/bin/pk2cmd
PK2DEVPATH= /usr/share/pk2

SOURCES = main.c usb.c leds.c i2c.c si7021A10.c
CHIP = 16F1455
EXEC = hygusb-firm.hex

LDFLAGS =

OBJS = $(SOURCES:.c=.p1)

$(EXEC): $(OBJS)
	$(CC) -O$(@:.hex=) --chip=$(CHIP) $(OBJS) $(LDFLAGS)

all: $(EXEC)

clean:
	rm -f MPLABXLog.xml*
	rm -f l.obj
	rm -f funclist
	rm -f prog.cmd
	rm -f $(EXEC).*
	rm -f startup.*
	rm -f *.d *.p1 *.pre


pickit3: $(EXEC)
	rm -f prog.cmd
	echo "Device PIC$(CHIP)" >> prog.cmd
	echo "Hwtool PICkit3 -p" >> prog.cmd
	echo "Program $(EXEC).hex" >> prog.cmd
	echo "Quit" >> prog.cmd
	$(MDB) prog.cmd
	@rm -f prog.cmd

pickit2:
	$(PK2CMD) -M -PPIC${CHIP} -F$(EXEC).hex -B$(PK2DEVPATH)


# Pre-compile and generate dependency informations
# Fix .d files generated by xc8 to be compatible with GNU Make
# Generate empty target for each depency to handle renamming/removing dependencies
#  see http://scottmcpeak.com/autodepend/autodepend.html
%.p1: %.c
	$(CC) --pass1 --chip=$(CHIP) $(CFLAGS) $<
	@sed -i "s/^.\+\.d[[:space:]]\+//" $*.d
	@sed -e 's/.*://; s/\\$$//' $*.d | fmt -1 | \
	  sed -e 's/^ */\n/;s/$$/:/' >> $*.d

-include $(SOURCES:.c=.d)
